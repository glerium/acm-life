name: cpp-build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [g++]

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install compiler
        run: sudo apt-get update && sudo apt-get install -y g++

      - name: Decide compile scope
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "[Full build] compiling all .cpp"
            git -c core.quotepath=false ls-files '*.cpp' > /tmp/targets.txt
          else
            echo "[Incremental] compiling changed .cpp only"
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              BASE="${{ github.event.pull_request.base.sha }}"
              HEAD="${{ github.event.pull_request.head.sha }}"
            else
              BASE="${{ github.event.before }}"
              HEAD="${{ github.sha }}"
            fi

            echo "Diff range: $BASE..$HEAD"
            git -c core.quotepath=false diff --name-only --diff-filter=ACMR "$BASE" "$HEAD" -- '*.cpp' > /tmp/targets.txt || true
          fi

          echo "Targets:"
          cat /tmp/targets.txt || true

      - name: Compile (parallel)
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -s /tmp/targets.txt ]; then
            echo "No cpp files to compile."
            exit 0
          fi

          COMP="${{ matrix.compiler }}"
          CXXFLAGS="-std=c++20 -pipe"
          JOBS="$(nproc)"

          echo "Compiler: $COMP"
          echo "Parallel jobs: $JOBS"

          : > /tmp/failed.txt

          xargs -P "$JOBS" -I{} bash -lc '
            f="$1"
            echo "==> $f"
            if ! "'"$COMP"'" '"$CXXFLAGS"' -fsyntax-only "$f"; then
              flock /tmp/failed.lock bash -lc "echo \"$f\" >> /tmp/failed.txt"
            fi
          ' _ {} < /tmp/targets.txt

          if [ -s /tmp/failed.txt ]; then
            echo ""
            echo "=== Failed files ($(wc -l < /tmp/failed.txt)) ==="
            sort -u /tmp/failed.txt
            exit 1
          fi
