name: cpp-build

on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        compiler: [g++]

    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install compiler + ccache
        run: sudo apt-get update && sudo apt-get install -y g++ ccache

      - name: Setup ccache
        shell: bash
        run: |
          set -euo pipefail
          echo "CCACHE_DIR=$HOME/.ccache" >> $GITHUB_ENV
          ccache --set-config=cache_dir=$HOME/.ccache
          ccache --set-config=max_size=2G
          ccache -z

      - name: Cache ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ runner.os }}-${{ matrix.compiler }}-${{ github.ref_name }}
          restore-keys: |
            ccache-${{ runner.os }}-${{ matrix.compiler }}-

      - name: Decide compile scope
        shell: bash
        run: |
          set -euo pipefail

          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "[Full build] compiling all .cpp"
            git ls-files '*.cpp' > /tmp/targets.txt
          else
            echo "[Incremental] compiling changed .cpp only"
            if [ "${{ github.event_name }}" = "pull_request" ]; then
              BASE="${{ github.event.pull_request.base.sha }}"
              HEAD="${{ github.event.pull_request.head.sha }}"
            else
              BASE="${{ github.event.before }}"
              HEAD="${{ github.sha }}"
            fi

            echo "Diff range: $BASE..$HEAD"
            git diff --name-only --diff-filter=ACMR "$BASE" "$HEAD" -- '*.cpp' > /tmp/targets.txt || true
          fi

          echo "Targets:"
          cat /tmp/targets.txt || true

      - name: Compile (parallel, syntax-only, ccache)
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -s /tmp/targets.txt ]; then
            echo "No cpp files to compile."
            exit 0
          fi

          COMP="${{ matrix.compiler }}"
          CXXFLAGS="-std=c++20 -pipe"
          JOBS="$(nproc)"

          echo "Compiler: $COMP"
          echo "Parallel jobs: $JOBS"

          : > /tmp/failed.txt

          xargs -P "$JOBS" -I{} bash -lc '
            f="$1"
            echo "==> $f"
            if ! ccache "'"$COMP"'" '"$CXXFLAGS"' -fsyntax-only "$f"; then
              flock /tmp/failed.lock bash -lc "echo \"$f\" >> /tmp/failed.txt"
            fi
          ' _ {} < /tmp/targets.txt

          if [ -s /tmp/failed.txt ]; then
            echo ""
            echo "=== Failed files ($(wc -l < /tmp/failed.txt)) ==="
            sort -u /tmp/failed.txt
            exit 1
          fi

      - name: ccache stats
        if: always()
        run: ccache -s
